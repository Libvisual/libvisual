INCLUDE(CMakeParseArguments)

FUNCTION(LV_BUILD_TEST TEST_NAME)
  SET(OPTION_ARGS "")
  SET(SINGLE_ARGS "")
  SET(MULTI_ARGS  "ARGS" "SOURCES" "COMPILE_DEFS" "COMPILE_OPTIONS" "INCLUDE_DIRS" "LINK_DIRS" "LINK_LIBS")
  CMAKE_PARSE_ARGUMENTS(PARSED_ARGS "${OPTION_FLAGS}" "${SINGLE_ARGS}" "${MULTI_ARGS}" ${ARGN})

  IF(NOT PARSED_ARGS_SOURCES)
    MESSAGE(FATAL_ERROR "Cannot build unit test '${TEST_NAME}', no source files specified.")
  ENDIF()

  ADD_EXECUTABLE(${TEST_NAME} ${PARSED_ARGS_SOURCES})

  IF(${PARSED_ARGS_COMPILE_DEFS})
    TARGET_COMPILE_DEFINITIONS(${TEST_NAME} PRIVATE ${PARSED_ARGS_COMPILE_DEFS})
  ENDIF()

  IF(${PARSED_ARGS_COMPILE_OPTIONS})
    TARGET_COMPILE_OPTIONS(${TEST_NAME} PRIVATE ${PARSED_ARGS_COMPILE_OPTIONS})
  ENDIF()

  TARGET_INCLUDE_DIRECTORIES(${TEST_NAME}
    PRIVATE
    ${PROJECT_SOURCE_DIR}
    ${PROJECT_BINARY_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_BINARY_DIR}
    ${PARSED_ARGS_INCLUDE_DIRS}
  )

  IF(${PARSED_ARGS_LINK_DIRS})
    TARGET_LINK_DIRECTORIES(${TEST_NAME} PRIVATE ${PARSED_ARGS_LINK_DIRS})
  ENDIF()

  TARGET_LINK_LIBRARIES(${TEST_NAME}
    PRIVATE
    libvisual
    Threads::Threads
    ${PARSED_ARGS_LINK_LIBS}
  )

  ADD_TEST(${TEST_NAME}
    ${CMAKE_COMMAND} -E chdir ${CMAKE_CURRENT_SOURCE_DIR} ${CMAKE_CURRENT_BINARY_DIR}/${TEST_NAME} ${PARSE_ARGS_ARGS}
  )
ENDFUNCTION()
